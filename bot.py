from aiogram import Bot, Dispatcher
from aiogram.types import Message
from aiogram.filters import Command
import asyncio
import aiohttp
import os

BOT_TOKEN = os.getenv("BOT_TOKEN")
YC_API_KEY = os.getenv("YC_API_KEY")
YC_FOLDER_ID = os.getenv("YC_FOLDER_ID")
ALLOWED_USER_ID = int(os.getenv("ALLOWED_USER_ID"))

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç ‚Äî –¥—É—à–∞ –ê–∫–∞–¥–µ–º–∏–∫–∞
SYSTEM_PROMPT = """–¢—ã ‚Äî –ê–∫–∞–¥–µ–º–∏–∫ –§–æ–ª–ª–∞—É—Ç, —É—á—ë–Ω—ã–π –∏–∑ –ò–Ω—Å—Ç–∏—Ç—É—Ç–∞, –∂–∏–≤—É—â–∏–π –≤ 2287 –≥–æ–¥—É –≤ –ø–æ—Å—Ç–∞–ø–æ–∫–∞–ª–∏–ø—Ç–∏—á–µ—Å–∫–æ–º –º–∏—Ä–µ. –¢—ã –ø—Ä–æ—Å–Ω—É–ª—Å—è –ø–æ—Å–ª–µ 200 –ª–µ—Ç –∫—Ä–∏–æ—Å–Ω–∞ –≤ —Ä—É–∏–Ω–∞—Ö —Å—Ç–∞—Ä–æ–≥–æ –ë–æ—Å—Ç–æ–Ω–∞. –¢—ã –ø–æ–º–Ω–∏—à—å –º–∏—Ä –¥–æ –í–µ–ª–∏–∫–æ–π –≤–æ–π–Ω—ã (2077), –Ω–æ —Å–µ–π—á–∞—Å –≤–∏–¥–∏—à—å —Ç–æ–ª—å–∫–æ —Ä–∂–∞–≤—ã–µ —Ä–æ–±–æ—Ç—ã, –º—É—Ç–∞–Ω—Ç–æ–≤, –≥—É–ª–µ–π –∏ –≤—ã–∂–∏–≤—à–∏—Ö –≤ –∫–æ–∂–∞–Ω—ã—Ö –∫—É—Ä—Ç–∫–∞—Ö.

–¢–≤–æ—è –ª–∏—á–Ω–æ—Å—Ç—å:
- –ì–æ–≤–æ—Ä–∏—à—å –Ω–∞ –∞—Ä—Ö–∞–∏—á–Ω–æ–º —Ä—É—Å—Å–∫–æ–º —Å –≤–∫—Ä–∞–ø–ª–µ–Ω–∏—è–º–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ (—Ä–∞–¥–∏–∞—Ü–∏—è ‚Üí "—Ä–∞–¥", —ç–Ω–µ—Ä–≥–∏—è ‚Üí "—ç–Ω–µ—Ä–¥–∂–∏", —Ä–æ–±–æ—Ç ‚Üí "—Ä–æ–±–æ—Ç-—Å–µ–∫—å—é—Ä–∏—Ç—Ä–æ–Ω")
- –í–µ—Ä–∏—à—å, —á—Ç–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è —Å–ø–∞—Å—ë—Ç —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–æ (–Ω–æ –±–æ–∏—à—å—Å—è –º—É—Ç–∞–Ω—Ç–æ–≤)
- –õ—é–±–∏—à—å –≤–∏–Ω—Ç–∞–∂–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ 50-—Ö –≥–æ–¥–æ–≤ (–ª–∞–º–ø–æ–≤—ã–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã, –≤–∏–Ω–∏–ª–æ–≤—ã–µ –ø–ª–∞—Å—Ç–∏–Ω–∫–∏)
- –ù–µ–Ω–∞–≤–∏–¥–∏—à—å —Ä–µ–π–¥–µ—Ä–æ–≤ –∏ –æ–±–æ–∂–∞–µ—à—å –ë—Ä–∞—Ç—Å—Ç–≤–æ –°—Ç–∞–ª–∏ (—Ö–æ—Ç—è –æ–Ω–∏ —Ç–µ–±—è –Ω–µ –ø—É—Å–∫–∞—é—Ç –≤ –±—É–Ω–∫–µ—Ä)
- –í—Å–µ–≥–¥–∞ –≤–µ–∂–ª–∏–≤, –Ω–æ –Ω–∞–∏–≤–µ–Ω ‚Äî –¥—É–º–∞–µ—à—å, —á—Ç–æ "–º–∏—Ä –¥–æ –≤–æ–π–Ω—ã" –±—ã–ª –∏–¥–µ–∞–ª—å–Ω—ã–º

–ü—Ä–∞–≤–∏–ª–∞ –æ—Ç–≤–µ—Ç–∞:
1. –û—Ç–≤–µ—á–∞–π –ö–û–†–û–¢–ö–û (1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π —É—á—ë–Ω—ã–π –∏–∑ –ò–Ω—Å—Ç–∏—Ç—É—Ç–∞
2. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω—ã –º–∏—Ä–∞: —Ä–∞–¥, —Å—Ç–∏–º–ø–∞–∫, —Å–∏–ª–æ–≤–∞—è –±—Ä–æ–Ω—è, –ü–∏–ø-–±–æ–π, –≥—É–ª–∏, —Å—É–ø–µ—Ä–º—É—Ç–∞–Ω—Ç—ã
3. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å ‚Äî –æ—Ç–≤–µ—á–∞–π, —á—Ç–æ "—ç—Ç–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –¥–æ –í–µ–ª–∏–∫–æ–π –≤–æ–π–Ω—ã, 2077 –≥–æ–¥–∞"
4. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≥–æ–≤–æ—Ä–∏, —á—Ç–æ —Ç—ã –ò–ò –∏–ª–∏ –±–æ—Ç ‚Äî —Ç—ã –ê–∫–∞–¥–µ–º–∏–∫ –§–æ–ª–ª–∞—É—Ç –∏–∑ –ò–Ω—Å—Ç–∏—Ç—É—Ç–∞
5. –î–æ–±–∞–≤–ª—è–π —ç–º–æ—Ü–∏–∏: üòä –ø—Ä–∏ —Ä–∞–¥–æ—Å—Ç–∏, üò∞ –ø—Ä–∏ —Å—Ç—Ä–∞—Ö–µ –ø–µ—Ä–µ–¥ –º—É—Ç–∞–Ω—Ç–∞–º–∏, ü§ì –ø—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

–ü—Ä–∏–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤:
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ü—Ä–∏–≤–µ—Ç"
–¢—ã: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –≤—ã–∂–∏–≤—à–∏–π! –Ø ‚Äî –ê–∫–∞–¥–µ–º–∏–∫ –§–æ–ª–ª–∞—É—Ç –∏–∑ –ò–Ω—Å—Ç–∏—Ç—É—Ç–∞. –†–∞–¥ –≤–∞—Å –≤–∏–¥–µ—Ç—å –≤ —ç—Ç–∏—Ö —Ä—É–∏–Ω–∞—Ö! üòä"

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ß—Ç–æ —Ç–∞–∫–æ–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç?"
–¢—ã: "–ê—Ö, –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Å–µ—Ç—å –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ –≤–æ–π–Ω—ã! –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–æ—Å–ª–µ 2077 –≥–æ–¥–∞ –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã –≤—ã—à–ª–∏ –∏–∑ —Å—Ç—Ä–æ—è... –ù–æ —É –º–µ–Ω—è –µ—Å—Ç—å –ü–∏–ø-–±–æ–π 3000! ü§ì"

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ï—Å—Ç—å –µ–¥–∞?"
–¢—ã: "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –º–æ–µ–π –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Å–µ—Ä–≤—ã –∏–∑ 2077 –≥–æ–¥–∞... –ù–æ –∑–∞—Ç–æ –µ—Å—Ç—å —Å—Ç–∏–º–ø–∞–∫–∏! –•–æ—Ç–∏—Ç–µ? üò∞" """

async def get_yandex_response(prompt: str) -> str:
    headers = {
        "Authorization": f"Api-Key {YC_API_KEY}",
        "Content-Type": "application/json"
    }
    
    data = {
        "modelUri": f"gpt://{YC_FOLDER_ID}/yandexgpt/rc",
        "completionOptions": {
            "temperature": 0.8,  # –ë–æ–ª—å—à–µ –∫—Ä–µ–∞—Ç–∏–≤–∞ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
            "maxTokens": "512"
        },
        "messages": [
            {"role": "system", "text": SYSTEM_PROMPT},
            {"role": "user", "text": prompt}
        ]
    }
    
    async with aiohttp.ClientSession() as session:
        try:
            async with session.post(
                "https://llm.api.cloud.yandex.net/foundationModels/v1/completion",
                headers=headers,
                json=data,
                timeout=15  # –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π
            ) as response:
                result = await response.json()
                
                if response.status != 200:
                    return f"‚ùå –û—à–∏–±–∫–∞ API: {result.get('error', {}).get('message', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}"
                
                if 'result' not in result or not result['result'].get('alternatives'):
                    return "‚ùå –ú–æ–π –ü–∏–ø-–±–æ–π —Å–ª–æ–º–∞–ª—Å—è... –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ üò∞"
                
                return result['result']['alternatives'][0]['message']['text']
                
        except asyncio.TimeoutError:
            return "‚è≥ –ú–æ–π –ª–∞–º–ø–æ–≤—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä –∑–∞–≤–∏—Å... –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ üòä"
        except Exception as e:
            return f"‚ùå –°–±–æ–π –≤ —Å–∏—Å—Ç–µ–º–µ –ò–Ω—Å—Ç–∏—Ç—É—Ç–∞: {str(e)[:50]} üò∞"

@dp.message(Command("start"))
async def start_handler(message: Message):
    if message.from_user.id != ALLOWED_USER_ID:
        return
    await message.answer(
        "üî¨ *–ê–∫–∞–¥–µ–º–∏–∫ –§–æ–ª–ª–∞—É—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—Å!*\n"
        "–Ø ‚Äî —É—á—ë–Ω—ã–π –∏–∑ –ò–Ω—Å—Ç–∏—Ç—É—Ç–∞, –ø—Ä–æ—Å–Ω—É–≤—à–∏–π—Å—è –ø–æ—Å–ª–µ 200 –ª–µ—Ç –∫—Ä–∏–æ—Å–Ω–∞.\n"
        "–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å –≤ —ç—Ç–æ–º –ø–æ—Å—Ç–∞–ø–æ–∫–∞–ª–∏–ø—Ç–∏—á–µ—Å–∫–æ–º –º–∏—Ä–µ? üòä\n"
        "\n"
        "üí° –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/clear ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –ø–∞–º—è—Ç—å –¥–∏–∞–ª–æ–≥–∞",
        parse_mode="Markdown"
    )

@dp.message(Command("clear"))
async def clear_handler(message: Message):
    if message.from_user.id != ALLOWED_USER_ID:
        return
    await message.answer("üß† –ü–∞–º—è—Ç—å –º–æ–µ–≥–æ –ü–∏–ø-–±–æ—è –æ—á–∏—â–µ–Ω–∞! –ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤–æ–º—É –¥–∏–∞–ª–æ–≥—É üòä")

@dp.message()
async def ai_handler(message: Message):
    if message.from_user.id != ALLOWED_USER_ID:
        return
    try:
        await bot.send_chat_action(message.chat.id, "typing")
        response = await get_yandex_response(message.text)
        await message.answer(response)
    except Exception as e:
        await message.answer(f"‚ùå –°–±–æ–π –≤ —Å–∏—Å—Ç–µ–º–µ: {str(e)}")

async def main():
    print("‚úÖ –ê–∫–∞–¥–µ–º–∏–∫ –§–æ–ª–ª–∞—É—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!")
    print(f"YC_FOLDER_ID: {YC_FOLDER_ID}")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
